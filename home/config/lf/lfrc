# todo duplicate switch statements
# todo libreoffice breaks randomly :(
# i think it gets stuck on file not found in the splash screen?

# todo use xdg-open????
cmd open ${{
	case $(file --mime-type -Lb "$f") in
                inode/x-empty)
                    nvim "$f"
                    ;;
 		text/*) 
		    nvim "$f"
		    ;;
		image/*)
		    nohup imv "$f" > /dev/null 2>&1 &
		    ;;
                video/*) 
                    nohup mpv --keep-open=yes --force-window=yes "$f" > /dev/null 2>&1 &
                    ;;
                audio/*)
                    nohup mpv --keep-open=yes --force-window=yes "$f" > /dev/null 2>&1 &
                    ;;
		application/pdf)
#https://unix.stackexchange.com/questions/3886/difference-between-nohup-disown-and
#maybe use &! or disown?
                # nohup so zathura is not closed when the terminal closes
                # i might want to use this for other things as well
		    nohup zathura "$f" > /dev/null 2>&1 &
		    ;;
		application/gzip)
		    nohup xournalpp "$f" > /dev/null 2>&1 &
		    ;;
                application/msword) 
                    nohup libreoffice "$f" > /dev/null 2>&1 &
                    ;;
                application/vnd.*)
                    nohup libreoffice "$f" > /dev/null 2>&1 &
                    ;;
		*) 
                    # what is this even doing
		    for f in $f; do
			echo $f $(file --mime-type -Lb $f)| less;
			# xdg-open $f > /dev/null 2> /dev/null &
		    done
		    ;;
	esac
}}

# show current directory in window title
cmd on-cd &{{
    # '&' commands run silently in background (which is what we want here),
    # but are not connected to stdout.
    # To make sure our escape sequence still reaches stdout we pipe it to /dev/tty
    printf "\033]0;$PWD\007" > /dev/tty
}}

# also run at startup
on-cd

# ctpv previews
set previewer ctpv
set cleaner ctpvclear
&ctpv -s $id
&ctpvquit $id


cmd fzf_search ${{
    lf -remote "send $id select $( \
        RG_PREFIX="rg --color=always --smart-case --column --line-number --heading --context=5"
        FZF_DEFAULT_COMMAND="$RG_PREFIX ''" \
            fzf \
            --disabled --ansi \
            --bind "change:reload:$RG_PREFIX {q} || true" \
            | cut -d ':' -f 1
        )"

#--layout-reverse?
#--header 'header'?
    #--delimiter ':' --preview 'bat --color=always {1} --highlight-line={2}' \
}}
# find grep
map fg :fzf_search
#https://github.com/gokcehan/lf/wiki/Integrations#fzf

# alt-enter to launch in new window
# todo preview with ctpv sixels :O, using bad for now
#todo fix not opening file and navigating
cmd fzf_find ${{
     lf -remote "send $id select $( \
         fzf --preview-window=up --preview="bat --force-colorization "{}"" \
            --bind="alt-enter:execute(swaymsg -t command exec \\\$term lf $(pwd)/{})+abort" \
         )"
         # I HATE SHELL ESCAPING
         # I HATE SHELL ESCAPING
         # I HATE SHELL ESCAPING
 # todo files with spaces dont work somehow bruh
# todo use "become" once fzf updates
# this way fzf isnt left hanging around
# not that it really does but whatever
}}
# find fuzzy
map ff :fzf_find
# unbind default find
map f



# bruh https://github.com/gokcehan/lf/issues/899
cmd delete %trash-put "$f"
# todo set editor
# set pager var?
map x :delete


#o open as
#map o
map ox &nohup xournalpp "$f" > /dev/null 2>&1
map oa &nohup audacity "$f" > /dev/null 2>&1
# todo make sure firefox is already open??
map of %firefox "$f"
map oo !"$f"

# n new
# todo use push
map n %printf 'new file: ' && read && touch "$REPLY" && lf -remote "send $id select $REPLY"
#tood new xournalpp new audacity

#g git commands

# git add
map gaa %git add "$f"
map gaA %git add .
# git add (incremental)
map gap $git add -p "$f"
map gaP $git add -p .
# git commit
map gc $git commit
# todo bats pager??
map gs $git -c color.ui=always status . | less -R
map gS $git -c color.ui=always status | less -R
# git diff
# --diff-filter=d excludes deleted files
map gdd $git diff --name-only --relative --diff-filter=d "$f" | xargs bat --diff --paging=always
map gdD $git diff --name-only --relative --diff-filter=d | xargs bat --diff --paging=always
# git diff --cached
# todo use dandavision/delta
# bat doesnt handled cached output
map gdc $git diff --cached --relative "$f"
map gdC $git diff --cached --relative
# git reset
map gr $git reset "$f"
map gR $git reset .
#find a safer way to delete local changes
#map gx $git checkout -- .

